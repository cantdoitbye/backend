# Notification User ID Clarification Document

## Current Situation Analysis

### 1. **Understanding `uid` vs `id` vs `user_id` in the Users Model**

Based on the `auth_manager/models.py` file, here's the structure:

```python
class Users(DjangoNode, StructuredNode):
    uid = UniqueIdProperty()  # Auto-generated unique identifier (Neo4j internal)
    user_id = StringProperty(unique_index=True, required=True)  # External reference ID
    username = StringProperty(unique_index=True)
    email = StringProperty(unique_index=True)
    # ... other fields
```

**Key Differences:**
- **`uid`**: Auto-generated by Neo4j (UniqueIdProperty) - This is a unique system-wide identifier
- **`user_id`**: Manually set string property - This is the external reference ID used across the system
- **`id`**: Neo4j's internal node ID (not explicitly defined but exists on all nodes)

### 2. **Current Notification Data Structure**

Looking at the `notification/models.py` (UserNotification model):

```python
class UserNotification(models.Model):
    user_uid = models.CharField(max_length=255)  # Stores the user's UID
    notification_type = models.CharField(max_length=100)
    title = models.CharField(max_length=255)
    body = models.TextField()
    device_id = models.CharField(max_length=255)
    # ... other fields
    data = models.JSONField(default=dict)  # Additional data payload
```

The `data` field is a JSON field that can contain any additional information.

### 3. **Current Notification Implementation**

#### In `notification/global_service.py`:

```python
def send(self, event_type: str, recipients: List[Dict[str, str]], **template_vars):
    """
    Args:
        recipients: List of dicts with 'device_id' and 'uid'
        **template_vars: Variables to fill in the template (username, post_id, etc.)
    """
```

Currently, recipients are expected to have:
- `device_id`: For FCM token
- `uid`: User's unique identifier

#### In `community/services/notification_service.py`:

```python
async def notifyCommunityCreated(self, creator_name: str, members: List[dict], ...):
    for member in members:
        if member.get('device_id'):
            notification_data = {
                "title": f"You've been added to {community_name}",
                "body": f"{creator_name} created a new community...",
                "token": member['device_id'],
                "data": {
                    "community_id": community_id,
                    "type": "community_created"
                }
            }
```

**Current Issue:** The `data` field only contains context-specific information (like `community_id`, `post_id`) but **does NOT include sender information** like:
- `sender_uid`: Who triggered the notification
- `sender_user_id`: The user_id of the sender
- `sender_id`: Alternative identifier

### 4. **What's Missing in Current Implementation**

When you query `myNotifications`, you get:

```json
{
  "id": 123,
  "title": "You've been added to TechCommunity",
  "body": "John created a new community...",
  "data": {
    "community_id": "abc123",
    "type": "community_created"
  }
}
```

**What's Missing:**
- No `sender_uid` (the uid of the person who triggered the notification)
- No `sender_user_id` (the user_id of the person who triggered the notification)
- No `sender_id` (alternative identifier)

### 5. **Your Confusion: What is `user_id` in Notifications?**

Based on your question, you're seeing `user_id` in the notification response with the same value in each notification. Let me clarify:

**In the UserNotification model:**
- `user_uid`: This is the **RECIPIENT's** uid (the person receiving the notification)
- There is NO `user_id` field in the UserNotification model currently

**If you're seeing `user_id` in the response, it's likely:**
1. Coming from the `data` JSON field
2. Being added by the GraphQL resolver
3. Or it's the recipient's user_id being returned

### 6. **What Needs to Be Added**

For notifications like `new_post_from_connection`, `new_comment_on_post`, etc., we need to include:

```python
notification_data = {
    "title": "...",
    "body": "...",
    "data": {
        # Existing fields
        "post_id": "...",
        "type": "new_post_from_connection",
        
        # NEW FIELDS TO ADD
        "sender_uid": "user_uid_who_created_post",  # Neo4j UID
        "sender_user_id": "user_id_who_created_post",  # External user_id
        "sender_username": "john_doe",  # For display purposes
        "sender_profile_pic": "image_id_123"  # Optional
    }
}
```

## Recommendations

### Option 1: Add Sender Info to All Notifications (Recommended)

Modify the notification sending logic to always include sender information:

```python
# In global_service.py or notification templates
def send(self, event_type: str, recipients: List[Dict], sender_info: Dict = None, **template_vars):
    """
    Args:
        sender_info: {
            'uid': 'sender_uid',
            'user_id': 'sender_user_id', 
            'username': 'sender_username',
            'profile_pic_id': 'optional_image_id'
        }
    """
    # Add sender_info to data payload
    notification_data['data'].update({
        'sender_uid': sender_info.get('uid'),
        'sender_user_id': sender_info.get('user_id'),
        'sender_username': sender_info.get('username'),
        'sender_profile_pic_id': sender_info.get('profile_pic_id')
    })
```

### Option 2: Add Sender Fields to UserNotification Model

Add explicit fields to the model:

```python
class UserNotification(models.Model):
    # Existing fields
    user_uid = models.CharField(max_length=255)  # Recipient
    
    # NEW FIELDS
    sender_uid = models.CharField(max_length=255, null=True, blank=True)
    sender_user_id = models.CharField(max_length=255, null=True, blank=True)
    sender_username = models.CharField(max_length=255, null=True, blank=True)
    
    # ... rest of fields
```

### Option 3: Hybrid Approach (Best)

- Store `sender_uid` and `sender_user_id` as model fields for querying
- Store additional sender info (username, profile_pic) in the `data` JSON field

## Next Steps

1. **Clarify Requirements:**
   - Do you want `uid` or `user_id` or both?
   - Do you need sender's username and profile picture?
   - Should this be in the model or just in the data payload?

2. **Identify All Notification Types:**
   - Which notifications need sender info?
   - Are there notifications without a sender (system notifications)?

3. **Update Implementation:**
   - Modify notification templates
   - Update all notification sending calls
   - Add migration if model changes are needed

## Questions to Answer Before Implementation

1. **Which identifier do you prefer?**
   - `uid` (Neo4j unique identifier)
   - `user_id` (external reference ID)
   - Both?

2. **What sender information is needed?**
   - Just IDs?
   - Username?
   - Profile picture?
   - Full profile data?

3. **Where should it be stored?**
   - Model fields (requires migration)
   - JSON data field (flexible, no migration)
   - Both (hybrid approach)?

4. **Which notifications need sender info?**
   - All notifications?
   - Only user-triggered notifications?
   - Specific types only?

---

**Please review this document and let me know:**
1. What you're seeing in the current `myNotifications` response
2. Which approach you prefer (Option 1, 2, or 3)
3. What specific sender information you need
4. Whether you want `uid`, `user_id`, or both
